---
title: "Sortino Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r, include = FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
```

Today, we begin a project to build a Shiny application that allows a user to build a portfolio and calculate/visualize its Sortino Ratio. 

The final app is viewable [here](https://jkr216.shinyapps.io/Sortino-Shiny/) but we'll spend the next 3 posts contructing that.

By way of brief background and motivation for this projct, the Sortino Ratio is a measure of the return/risk ratio of a portfolio and is an important tool for evaluating the risk adjusted returns of a portfolio and the skill of the portfolio manager. A higher Sortino indicates a portfolio manager who is generating higher returns per unit of risk absorbed.  Identifying better performing portfolios and portfolio managers is crucial for quants, data scientist and analysts at banks, endowments, investment advisors, funds of funds, hedge funds - all enterprise-level participants in the world of asset management.  From a data science perspective, we want to accomplish this using a reproducible work flow and an appealing, digestible end product.  As someone who used to work in finance and now works at RStudio, I find a Sortino Ratio Shiny app to be a thrilling combination of portfolio theory, statistical analysis and data visualization. Let's get to it!

The Sortino Ratio eqation is as follows:   

$$Sortino~Ratio_{portfolio}=\frac{(\overline{Return_{portfolio}-MAR})}{\sqrt{\sum_{t=1}^n min(R_t-MAR,~0)^2}/n}$$

The denominator in that equation (called the Downside Deviation, semi-deviation or downside risk) can be thought of as the deviation of the returns that fall below some target rate of return for the portfolio. That target rate is called the Minimum Acceptable Rate, or MAR. The numerator is the mean portfolio return minus the MAR and can be thought of as excess returns. 

The theory behind the Sortino Ratio is that the riskiness of a portfolio is better measured by the deviation of returns *below* a target return, instead of by the standard deviation of all returns.  This stands in contradistinction to the more commonly used Sharpe Ratio, which measures return/risk by the ratio of the returns above the risk free rate divided by the standard deviation of *all* returns.  By way of history, Harry Markowitz, Nobel laureate and father of modern portfolio theory, noted that downside deviation might be a better measure of risk than the standard deviation of all returns, but its calculation was computationally too expensive[^1] (it was 1959, if he only he'd had R on his laptop).

[^1]: Markowitz, Harry. Portfolio Selection: Efficient Diversification of Investments, John Wiley & Sons, 1959.

Frank Sortino's original article on downside deviation, "On the Use and Misuse of Downside Risk," was published in the [Journal of Portfolio Management](http://www.iijournals.com/doi/abs/10.3905/jpm.1996.35) in 1996 but you'll need a paid subscription to access that.

More background is available from the [CME group](http://www.cmegroup.com/education/files/sortino-a-sharper-ratio.pdf), [Red Rock Capital](http://www.redrockcapital.com/Sortino__A__Sharper__Ratio_Red_Rock_Capital.pdf) and [CFA pubs](http://www.cfapubs.org/doi/pdf/10.2469/ipmn.v2012.n1.1).


    
Minimum Acceptable Rate
    
    + MAR = .008 or .8%
    + Note we are holding this portfolio to a higher standard than being above 0%.


Next we choose our asset weights and assign them to the variable `w`. We will also assign the MAR of .008 to the variable `MAR`.

```{r}

MAR <- .008

```


```{r}
sortino_xts <- 
  SortinoRatio(portfolio_returns_xts_rebalanced_monthly, MAR = MAR) %>% 
  `colnames<-`("ratio")
```

From a substantive perspective, we could stop here and start visualizing with `highcharter`. 

Instead, we will run the calculation by-hand, implementing the equation for the Sortino Ratio via pipes and `dplyr`.  It's not a verbose piped workflow. In short, we call `summarise(ratio = mean(returns - MAR)/sqrt(sum(pmin(returns - MAR, 0)^2)/nrow(.)))`.  


```{r}
sortino_byhand <- 
  portfolio_returns_tq_rebalanced_monthly %>% 
  summarise(ratio = mean(returns - MAR)/sqrt(sum(pmin(returns - MAR, 0)^2)/nrow(.)))

sortino_byhand
```


Now on to `tidyquant`, which allows us to apply the `SortinoRatio` function from `PerformanceAnalytics` to a `tibble`. As long as we are passing it the same data as we passed originally with the `xts` object, we expect the same result.


```{r}
sortino_tidy <- 
  portfolio_returns_tq_rebalanced_monthly %>%
  tq_performance(Ra = returns, 
                 performance_fun = SortinoRatio, 
                 MAR = MAR,
                 method = "full") %>% 
  `colnames<-`("ratio")
```

Let's compare our 3 Sortino objects. 

```{r}
sortino_xts[1]
sortino_byhand$ratio
sortino_tidy$ratio
```

We have consistent results from `xts`, `tidyquant` and our by-hand piped calculation.  It might feel like a lot of work to get the same result three times but it forced us to look under the hood of the built-in functions and it might serve us well in the future should we have data or a project that fits better with one of the three methods.  


When we originally calculated Sortino by-hand in the tidy world, we used `summarise` to create one new cell for our end result. The code was `summarise(ratio = mean(returns - MAR)/sqrt(sum(pmin(returns - MAR, 0)^2)/nrow(.)))`.  

Today, we will make two additions to assist in our data visualization. We will add a column for returns that follow below MAR with `mutate(returns_below_MAR = ifelse(returns < MAR, returns, NA))` and add a column for returns above MAR with `mutate(returns_above_MAR = ifelse(returns > MAR, returns, NA))`. This is not necessary for calculating the Sortino, but we will see how it makes our ggplotting a bit easier and it illustrates a benefit of doing things by-hand with `dplyr`: if we want to extract or create certain data tranformations, we can add it to the piped code flow.

```{r}

# Tibble object
sortino_byhand <- 
  portfolio_returns_tq_rebalanced_monthly %>% 
  mutate(ratio = mean(returns - MAR)/sqrt(sum(pmin(returns - MAR, 0)^2)/nrow(.))) %>% 
  # Add two new columns to help with ggplot.
  mutate(returns_below_MAR = ifelse(returns < MAR, returns, NA)) %>%
  mutate(returns_above_MAR = ifelse(returns > MAR, returns, NA))

```

We now have two objects in our global environment, `sortino_xts` and `sortino_byhand`. 

Let's work with `sortino_byhand` and start with a scatterplot of returns using `ggplot`. 

The goal is to quickly grasp how many of our returns are above the MAR and how many are below the MAR. When we calculated the Sortino above, we created new columns for `returns_above_MAR` and `returns_below_MAR` columns. It makes this visualization a straightforward construct.

We will create green points for returns above MAR with `geom_point(aes(y = returns_above_MAR), colour = "green")` and red points for returns below MAR with `geom_point(aes(y = returns_below_MAR), colour = "red") `.  

I'm always curious how portfolios have performed since the election so we'll add a blue vertical line at November of 2016.  We will also include a horizontal purple dotted line at the MAR.

```{r, warning = FALSE, message = FALSE}
sortino_byhand %>% 
  ggplot(aes(x = date)) +
  geom_point(aes(y = returns_below_MAR), colour = "red") +
  geom_point(aes(y = returns_above_MAR), colour = "green") + 
  geom_vline(xintercept = as.numeric(as.Date("2016-11-30")), color = "blue") +
  geom_hline(yintercept = MAR, color = "purple", linetype = "dotted") +
  annotate(geom="text", x=as.Date("2016-11-30"), 
           y = -.15, label = "Election", fontface = "plain", 
           angle = 90, alpha = .5, vjust =  1.5) +
  ylab("percent monthly returns")
```


It appears that about half of our returns fall below the MAR. Do we consider that to be a successful portfolio? This is not a rigorous test - what strikes us from the number of red dots and where they fall? Do we notice a trend? A period with consistently below or above MAR returns?

Since the election in 2016, there has been only one monthly return below the MAR and that will lead to a large Sortino since November. 

Next we will build a histogram of the distribution of returns with `geom_histogram(alpha = 0.25, binwidth = .01, fill = "cornflowerblue")`. We will again add a line for the MAR.

```{r}
sortino_byhand %>% 
  ggplot(aes(x = returns)) +
  geom_histogram(alpha = 0.25, binwidth = .01, fill = "cornflowerblue") +
  geom_vline(xintercept = MAR, color = "green") +
  annotate(geom = "text", x = MAR,
    y = 22, label = "MAR", fontface = "plain", angle = 90, alpha = .5, vjust =  1)

```

I notice a slight negative skew and a mode that is above MAR - some good motivation to take note that the mean monthly return is `r round(mean(sortino_byhand$returns), 3)`, which is below our MAR of `r MAR`.  We already had a sense for this since the Sortino Ratio is negative.

The Sortino Ratio and portfolio returns in general are usually accompanied by a density plot and we'll build one now. First, we will start simple with `stat_density(geom = "line", size = 1, color = "cornflowerblue")` to create a `ggplot` object called `sortino_density_plot`.

```{r}

sortino_density_plot <- 
  sortino_byhand %>% 
  ggplot(aes(x = returns)) +
  stat_density(geom = "line", size = 1, color = "cornflowerblue") 

sortino_density_plot
```

The slight negative skew is a bit more evident here. It would be nice to shade the area that falls below the MAR.  To do that, let's create an object called `shaded_area` using `ggplot_build(p)$data[[1]] %>% filter(x < MAR)`. That snippet will take our original `ggplot` object and create a new object filtered for x values less than MAR. Then we use `geom_area` to add the shaded area to `sortino_density_plot`.

```{r}
# use ggplot_build to get the p object; it returns a list of 1 data frame, not a dataframe
# so to access the dataframe we need to call [[1]]

shaded_area_data <- ggplot_build(sortino_density_plot)$data[[1]] %>% 
  filter(x < MAR)

sortino_density_plot_shaded <- sortino_density_plot + 
  geom_area(data = shaded_area_data, aes(x = x, y = y), fill="pink", alpha = 0.5) 

sortino_density_plot_shaded
```


Let's add a vertical line label at the exact MAR and an arrow to tell people where downside volatility resides. Note how we can keep adding layers to the `sortino_density_plot_shaded` object from above, which is one of great features of `ggplot`. It allows experimentation with aesthetics without changing the core plot with each iteration.

```{r}

sortino_density_plot_shaded +
  geom_segment(aes(x = 0, y = 1, xend = -.05, yend = 1),
  arrow = arrow(length = unit(0.5, "cm"))) +
  geom_segment(data = shaded_area_data, aes(x = MAR, y = 0, xend = MAR, yend = y), 
               color = "red", linetype = "dotted") +
  annotate(geom = "text", x = MAR, y = 5, label = "MAR = 0.8%", 
           fontface = "plain", angle = 90, alpha = .8, vjust =  -1) +
  annotate(geom = "text", x = -.02, y = .1, label = "Downside", 
           fontface = "plain", alpha = .8, vjust =  -1)
```

As with our scatterplot, we have not been shy about aesthetic layering but one goal here is to explore `ggplot` tools, which gives us license to be overinclusive.  

We have done some good work for visualizing the portfolio's returns and how they are distributed relative to the MAR, and how the MAR separates part of the the returns to downside risk. That gives us some intution about the Sortino Ratio.

We have not, however, touched the actual Sortino Ratio yet.  We will do so now.  

The ratio itself is one number: `r round(sortino_xts[1], 3)`. That doesn't allow much by way of dynamic visualization. So, we will visualize the Sortino Ratio over time and to do that we will need to calculate the rolling ratio. There is a slight wrinkle though - remember that we exclude above MAR returns from the denominator. If our rolling window is too small, we might end up with a denominator that includes 1 or 2 or 0 downside deviations. That would accurately reflect that the portfolio has done well in that small window but it might report a misleadingly huge number for the rolling window. The rolling 6 month demonstrates this. 

First, we need to calculate the rolling 6-month Sortino with `rollapply(portfolio_returns_xts, 6, function(x) SortinoRatio(x))`. Then we can visualize with `highcharter`.

```{r}
# calculate 6-month rolling Sortino
sortino_roll_6 <- 
  rollapply(portfolio_returns_xts_rebalanced_monthly, 6,function(x) SortinoRatio(x, MAR = MAR)) %>% 
  `colnames<-`("6-rolling")

sortino_roll_6[20:24]

```

Take a quick peek at the rolling 6-month for the dates September of 2006 through January of 2007.  What happened to cause that spike to 176! When we calculate Sortino over short time periods, strange results can occur. 

Let's chart with `highcharter` and investigate other unusual occurrences when we slice the data.

```{r}
# Pass to highcharter
highchart(type = "stock") %>%
  hc_title(text = "Rolling Sortino") %>%
  hc_add_series(sortino_roll_6, name = "Sortino", color = "blue") %>%
  hc_navigator(enabled = FALSE) %>% 
  hc_scrollbar(enabled = FALSE)
```

The rolling 6-month has so many bizarre spikes, e.g. a reading of 176 on January 31, 2007 and a reading of 9 on September 30, 2009 before breaching 100 in 2016! It nicely emphasizes how we need to be careful with the Sortino Ratio, short time periods and rolling applications.

Let's see how the rolling 24-month compares.

```{r}
sortino_roll_24 <- rollapply(portfolio_returns_xts_rebalanced_monthly, 5, 
                           function(x) SortinoRatio(x, MAR = MAR))

highchart(type = "stock") %>%
  hc_title(text = "Rolling Sortino") %>%
  hc_add_series(sortino_roll_24, name = "Sortino 24", color = "green") %>%
  hc_navigator(enabled = FALSE) %>% 
  hc_scrollbar(enabled = FALSE)
```

Ah, much better. We can see the movements and how the Sortino has changed through the life of this portfolio, but within a reasonable range of .6 to -0.4.

Rolling Sortinos need to be handled with care but there are a few nice payoffs First, these charts force us and our end users to reflect on how time periods can affect Sortino to extremes. Be skeptical if someone reports a fantastic 6-month Sortino. Second, as an exploratory device, the rolling ratios highligh time periods deserving of more investigation.  Third, with Sortino (and Sharpe) Ratios, there's a temptation to look at the final number for a portfolio's life and judge it 'good' or 'bad'. These rolling visualizations can help reframe the analysis and look at how the portfolio behaved in different economic and market regimes.


